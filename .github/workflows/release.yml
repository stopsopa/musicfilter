name: Release Build

on:
  # Trigger 1: Global Event Listener
  # This waits for a GitHub global event. Specifically, when someone (or a bot using a Personal Access Token)
  # creates a new Release in the "Releases" tab.
  # Note: Releases created by the default GITHUB_TOKEN will NOT trigger this (to prevent recursion).
  release:
    types: [published]
  # This trigger allows this workflow to be called by other workflows (like bump-version.yml)
  workflow_call:
    inputs:
      tag_name:
        description: "The tag to release (e.g. v1.0.0). Defaults to github.ref_name."
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-mac:
    runs-on: macos-latest
    steps:
      - name: ðŸ” State Check (Initial)
        run: |
          echo "GITHUB_ENV path: >$GITHUB_ENV<"
          echo "--- STEP Markers ---"
          env | grep "STEP_" | sort || echo "No STEP markers yet"
          echo "--- Context ---"
          echo "Event: >${{ github.event_name }}<"
          echo "Input tag_name: >${{ inputs.tag_name }}<"
          echo "Ref: >${{ github.ref_name }}<"

      - uses: actions/checkout@v4
        with:
          # If called via workflow_call, use the passed input.tag_name
          # If triggered via release:published, use the default github.ref
          ref: ${{ inputs.tag_name || github.ref }}

      - name: ðŸ” State Check (After Checkout)
        run: |
          echo "STEP_RELEASE_CHECKOUT=true" >> $GITHUB_ENV
          env | grep "STEP_" | sort

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22 # Updated to 22 for consistency
          cache: "npm"
          cache-dependency-path: electron/package-lock.json

      - name: ðŸ” State Check (After Node)
        run: |
          echo "STEP_RELEASE_NODE_READY=true" >> $GITHUB_ENV
          env | grep "STEP_" | sort

      - name: Install Dependencies
        working-directory: ./electron
        run: npm ci

      - name: ðŸ” State Check (After Deps)
        run: |
          echo "STEP_RELEASE_DEPS_DONE=true" >> $GITHUB_ENV
          env | grep "STEP_" | sort

      - name: Sync version from tag
        working-directory: ./electron
        run: |
          # Determine the version string to use
          REF_NAME=${{ inputs.tag_name || github.ref_name }}
          # We strictly need to strip the 'v' prefix (v1.0.0 -> 1.0.0) for valid package.json versioning
          VERSION=${REF_NAME#v}
          echo "Setting version to $VERSION"

          # MAGIC STEP 1: Update package.json version locally
          # We use --no-git-tag-version so it changes the file on disk BUT DOES NOT commit it.
          # This allows electron-builder to see the correct version (e.g. 1.0.1) instead of 0.0.0-dev
          # without creating messy "Bump version" commits in your git history.
          npm version $VERSION --no-git-tag-version

      - name: ðŸ” State Check (After Sync)
        run: |
          echo "STEP_RELEASE_SYNC_DONE=true" >> $GITHUB_ENV
          env | grep "STEP_" | sort

      - name: Build React App and Main Process
        working-directory: ./electron
        run: npm run build

      - name: ðŸ” State Check (After Build)
        run: |
          echo "STEP_RELEASE_BUILD_DONE=true" >> $GITHUB_ENV
          env | grep "STEP_" | sort

      - name: Build and Publish Electron App
        working-directory: ./electron
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # MAGIC STEP 2: Publish to GitHub
        # - electron-builder reads the version from package.json (set in step above)
        # - It packages the app (creating .dmg because of "mac": { "target": "dmg" } in package.json)
        # - It uploads the .dmg to the EXISTING GitHub Release that matches this version.
        # Note: The Release MUST already exist (created by semantic-release in the previous workflow)
        # for this step to succeed.
        run: npx electron-builder --mac --publish always
        # warning: in order to avoid issue in this step:
        # GitHub release not created  reason=existing type not compatible with publishing type tag=v1.4.1 version=1.4.1 existingType=release publishingType=draft
        # it is needed to add to package.json "publish": { "provider": "github", "releaseType": "release" }

      # Imperative Upload of package.json to Release Page
      - name: ðŸ” State Check (After Publish)
        run: |
          echo "STEP_RELEASE_PUBLISH_DONE=true" >> $GITHUB_ENV
          env | grep "STEP_" | sort

      - name: Upload package.json to Release Page
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME=${{ inputs.tag_name || github.ref_name }}
          gh release upload $TAG_NAME package.json --clobber
          # gh release upload $TAG_NAME .github/workflows/* --clobber

      # Failsafe: Upload artifact to Actions Run as well
      # This ensures you can access the binary even if the Github Release upload fails
      # WARNING: this will upload to action page not to release page - so we don't need that here
      # - name: Upload Release Artifact (Backup)
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: release-dmg
      #     path: electron/release/*.dmg
      #     retention-days: 5

      - name: ðŸ” State Check (Final)
        run: env | grep "STEP_" | sort

      - name: ðŸ“¢ Release Summary
        if: success()
        run: |
          TAG_NAME=${{ inputs.tag_name || github.ref_name }}
          REPO_URL="https://github.com/${{ github.repository }}"
          RELEASE_URL="$REPO_URL/releases/tag/$TAG_NAME"

          echo "### ðŸš€ Release Published Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "You can view the release and download the DMG here:" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘‰ [**$TAG_NAME**]($RELEASE_URL)" >> $GITHUB_STEP_SUMMARY
